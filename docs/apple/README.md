# Apple Store æ”¯ä»˜æ¥å…¥æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•æ¥å…¥ Apple åº”ç”¨å†…è´­ä¹°ï¼ˆIAPï¼‰å’Œè®¢é˜…åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [é…ç½®](#é…ç½®)
- [æ”¯ä»˜æµç¨‹](#æ”¯ä»˜æµç¨‹)
- [API æ¥å£](#api-æ¥å£)
- [Webhook å¤„ç†](#webhook-å¤„ç†)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## åŠŸèƒ½æ¦‚è¿°

æ”¯æŒçš„åŠŸèƒ½ï¼š

| åŠŸèƒ½ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|-----|
| ä¸€æ¬¡æ€§è´­ä¹° | æ¶ˆè€—å‹/éæ¶ˆè€—å‹å•†å“ | âœ… |
| è‡ªåŠ¨ç»­æœŸè®¢é˜… | Auto-Renewable Subscription | âœ… |
| æ”¶æ®éªŒè¯ | Receipt Validation | âœ… |
| äº¤æ˜“éªŒè¯ | Transaction Verification (æ¨è) | âœ… |
| äº¤æ˜“å†å² | Transaction History | âœ… |
| Server Notifications V2 | æœåŠ¡å™¨é€šçŸ¥ | âœ… |

## é…ç½®

### 1. åˆ›å»º App Store Connect API å¯†é’¥

1. ç™»å½• [App Store Connect](https://appstoreconnect.apple.com/)
2. è¿›å…¥ **ç”¨æˆ·å’Œè®¿é—® > å¯†é’¥ > App Store Connect API**
3. ç‚¹å‡» **+** åˆ›å»ºæ–°å¯†é’¥
4. é€‰æ‹© **App ç®¡ç†** æƒé™
5. ä¸‹è½½å¯†é’¥æ–‡ä»¶ï¼ˆ.p8ï¼‰ï¼Œè®°å½• Key ID å’Œ Issuer ID

### 2. é…ç½®æœåŠ¡å™¨é€šçŸ¥

1. è¿›å…¥ **æˆ‘çš„ App > App ä¿¡æ¯**
2. é…ç½® **App Store æœåŠ¡å™¨é€šçŸ¥**ï¼š
   - ç”Ÿäº§æœåŠ¡å™¨ URL: `https://your-domain.com/webhook/apple`
   - æ²™ç›’æœåŠ¡å™¨ URL: `https://your-domain.com/webhook/apple`
   - ç‰ˆæœ¬ï¼šé€‰æ‹© **ç‰ˆæœ¬ 2**

### 3. é…ç½® config.toml

```toml
[apple]
# App Store Connect API å¯†é’¥ ID
key_id = "ABC123DEF4"

# å‘è¡Œè€… ID
issuer_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# Bundle ID
bundle_id = "com.example.app"

# ç§é’¥å†…å®¹æˆ–è·¯å¾„
private_key = '''
-----BEGIN PRIVATE KEY-----
MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQg...
-----END PRIVATE KEY-----
'''
# æˆ–è€…ä½¿ç”¨æ–‡ä»¶è·¯å¾„
# private_key_path = "/path/to/AuthKey_ABC123DEF4.p8"

# æ˜¯å¦ä¸ºæ²™ç›’ç¯å¢ƒ
sandbox = true
```

## æ”¯ä»˜æµç¨‹

### ä¸€æ¬¡æ€§è´­ä¹°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸€æ¬¡æ€§è´­ä¹°æµç¨‹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å®¢æˆ·ç«¯ (iOS)               æœåŠ¡ç«¯                      Apple Server
        â”‚                        â”‚                             â”‚
        â”‚  1. åˆ›å»ºè®¢å•           â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                             â”‚
        â”‚  POST /apple/purchases â”‚                             â”‚
        â”‚                        â”‚                             â”‚
        â”‚  è¿”å› order_id         â”‚                             â”‚
        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                             â”‚
        â”‚                        â”‚                             â”‚
        â”‚  2. å‘èµ· StoreKit è´­ä¹° â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
        â”‚                        â”‚                             â”‚
        â”‚  è¿”å› Transaction      â”‚                             â”‚
        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚  (åŒ…å« transactionId, originalTransactionId)        â”‚
        â”‚                        â”‚                             â”‚
        â”‚  3. å‘é€äº¤æ˜“éªŒè¯è¯·æ±‚    â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                             â”‚
        â”‚  POST /apple/verify-transaction                     â”‚
        â”‚  {transaction_id, order_id}                         â”‚
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  è°ƒç”¨ App Store Server API  â”‚
        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
        â”‚                        â”‚  Get Transaction Info       â”‚
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  è¿”å›äº¤æ˜“è¯¦æƒ…               â”‚
        â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  ä¿å­˜æ”¯ä»˜è®°å½•               â”‚
        â”‚                        â”‚  æ›´æ–°è®¢å•çŠ¶æ€               â”‚
        â”‚                        â”‚                             â”‚
        â”‚  è¿”å›éªŒè¯ç»“æœ          â”‚                             â”‚
        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                             â”‚
        â”‚                        â”‚                             â”‚
        â”‚  4. å®Œæˆäº¤æ˜“           â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
        â”‚  finishTransaction()   â”‚                             â”‚
        â”‚                        â”‚                             â”‚
        â””                        â””                             â””
```

### è®¢é˜…æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              è®¢é˜…æµç¨‹                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å®¢æˆ·ç«¯ (iOS)               æœåŠ¡ç«¯                      Apple Server
        â”‚                        â”‚                             â”‚
        â”‚  1. åˆ›å»ºè®¢é˜…è®¢å•       â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                             â”‚
        â”‚  POST /apple/subscriptions                          â”‚
        â”‚                        â”‚                             â”‚
        â”‚  è¿”å› order_id         â”‚                             â”‚
        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                             â”‚
        â”‚                        â”‚                             â”‚
        â”‚  2. å‘èµ· StoreKit è®¢é˜… â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
        â”‚                        â”‚                             â”‚
        â”‚  è¿”å› Transaction      â”‚                             â”‚
        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚                        â”‚                             â”‚
        â”‚  3. éªŒè¯äº¤æ˜“           â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                             â”‚
        â”‚  POST /apple/verify-transaction                     â”‚
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  éªŒè¯ & ä¿å­˜               â”‚
        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
        â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚                        â”‚                             â”‚
        â”‚  è¿”å›è®¢é˜…çŠ¶æ€          â”‚                             â”‚
        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                             â”‚
        â”‚                        â”‚                             â”‚
        â”‚  4. å®Œæˆäº¤æ˜“           â”‚                             â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
        â”‚                        â”‚                             â”‚
        â””                        â”‚                             â”‚
                                 â”‚                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åç»­ç»­è´¹/çŠ¶æ€å˜æ›´ (Server Notification V2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  Webhook é€šçŸ¥               â”‚
        â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚                        â”‚  POST /webhook/apple        â”‚
        â”‚                        â”‚  {signedPayload: "..."}     â”‚
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  è§£æ JWS ç­¾å              â”‚
        â”‚                        â”‚  - éªŒè¯ç­¾å                 â”‚
        â”‚                        â”‚  - è§£ç  payload             â”‚
        â”‚                        â”‚  - æå–äº¤æ˜“/ç»­è®¢ä¿¡æ¯        â”‚
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  æ ¹æ®é€šçŸ¥ç±»å‹å¤„ç†           â”‚
        â”‚                        â”‚  - DID_RENEW: ç»­è´¹æˆåŠŸ      â”‚
        â”‚                        â”‚  - EXPIRED: è®¢é˜…è¿‡æœŸ        â”‚
        â”‚                        â”‚  - REFUND: é€€æ¬¾             â”‚
        â”‚                        â”‚                             â”‚
        â”‚                        â”‚  è¿”å› 200 OK               â”‚
        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
        â”‚                        â”‚                             â”‚
        â””                        â””                             â””
```

## API æ¥å£

### åˆ›å»ºå†…è´­è®¢å•

```http
POST /api/v1/apple/purchases
Content-Type: application/json

{
  "user_id": 1,
  "product_id": "com.example.premium",
  "title": "é«˜çº§ç‰ˆ",
  "description": "è§£é”æ‰€æœ‰åŠŸèƒ½",
  "quantity": 1,
  "currency": "USD",
  "price": 999,
  "developer_payload": "user_123"
}
```

**å“åº”ï¼š**

```json
{
  "status": "success",
  "message": "å†…è´­è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "order_no": "ORD20240101120000abcd1234",
    "user_id": 1,
    "product_id": "com.example.premium",
    "type": "PURCHASE",
    "status": "CREATED",
    "payment_method": "APPLE_STORE",
    "total_amount": 999,
    "currency": "USD"
  }
}
```

### åˆ›å»ºè®¢é˜…è®¢å•

```http
POST /api/v1/apple/subscriptions
Content-Type: application/json

{
  "user_id": 1,
  "product_id": "com.example.subscription.monthly",
  "title": "æœˆåº¦ä¼šå‘˜",
  "description": "æ¯æœˆè‡ªåŠ¨ç»­è´¹",
  "currency": "USD",
  "price": 999,
  "period": "P1M",
  "developer_payload": "user_123"
}
```

### éªŒè¯äº¤æ˜“ï¼ˆæ¨èï¼‰

ä½¿ç”¨ App Store Server API éªŒè¯äº¤æ˜“ï¼Œè¿™æ˜¯æ¨èçš„éªŒè¯æ–¹å¼ï¼š

```http
POST /api/v1/apple/verify-transaction
Content-Type: application/json

{
  "transaction_id": "1000000123456789",
  "order_id": 1
}
```

**å“åº”ï¼š**

```json
{
  "status": "success",
  "message": "Transaction verified successfully",
  "data": {
    "transaction_id": "1000000123456789",
    "original_transaction_id": "1000000123456780",
    "product_id": "com.example.premium",
    "bundle_id": "com.example.app",
    "purchase_date": "2024-01-01T12:00:00Z",
    "quantity": 1,
    "status": "VERIFIED"
  }
}
```

### éªŒè¯æ”¶æ®ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰

```http
POST /api/v1/apple/verify-receipt
Content-Type: application/json

{
  "receipt_data": "base64_encoded_receipt_data",
  "order_id": 1,
  "is_sandbox": true
}
```

### è·å–äº¤æ˜“å†å²

```http
GET /api/v1/apple/transactions/1000000123456780/history
```

**å“åº”ï¼š**

```json
{
  "status": "success",
  "data": [
    {
      "transaction_id": "1000000123456789",
      "original_transaction_id": "1000000123456780",
      "product_id": "com.example.subscription.monthly",
      "purchase_date": "2024-01-01T12:00:00Z",
      "expires_date": "2024-02-01T12:00:00Z"
    },
    {
      "transaction_id": "1000000123456790",
      "original_transaction_id": "1000000123456780",
      "product_id": "com.example.subscription.monthly",
      "purchase_date": "2024-02-01T12:00:00Z",
      "expires_date": "2024-03-01T12:00:00Z"
    }
  ]
}
```

### è·å–è®¢é˜…çŠ¶æ€

```http
GET /api/v1/apple/subscriptions/1000000123456780/status
```

## Webhook å¤„ç†

### Server Notification V2 é€šçŸ¥ç±»å‹

| ç±»å‹ | å­ç±»å‹ | è¯´æ˜ |
|-----|--------|-----|
| `SUBSCRIBED` | `INITIAL_BUY` | é¦–æ¬¡è®¢é˜… |
| `SUBSCRIBED` | `RESUBSCRIBE` | é‡æ–°è®¢é˜… |
| `DID_RENEW` | - | ç»­è´¹æˆåŠŸ |
| `DID_FAIL_TO_RENEW` | `GRACE_PERIOD` | ç»­è´¹å¤±è´¥ï¼ˆå®½é™æœŸå†…ï¼‰ |
| `DID_FAIL_TO_RENEW` | - | ç»­è´¹å¤±è´¥ |
| `DID_CHANGE_RENEWAL_STATUS` | `AUTO_RENEW_ENABLED` | å¼€å¯è‡ªåŠ¨ç»­è´¹ |
| `DID_CHANGE_RENEWAL_STATUS` | `AUTO_RENEW_DISABLED` | å…³é—­è‡ªåŠ¨ç»­è´¹ |
| `DID_CHANGE_RENEWAL_PREF` | - | ç»­è´¹åå¥½å˜æ›´ |
| `EXPIRED` | `VOLUNTARY` | ç”¨æˆ·å–æ¶ˆå¯¼è‡´è¿‡æœŸ |
| `EXPIRED` | `BILLING_RETRY` | è®¡è´¹é‡è¯•å¤±è´¥è¿‡æœŸ |
| `EXPIRED` | `PRICE_INCREASE` | æ‹’ç»æ¶¨ä»·å¯¼è‡´è¿‡æœŸ |
| `GRACE_PERIOD_EXPIRED` | - | å®½é™æœŸè¿‡æœŸ |
| `REFUND` | - | é€€æ¬¾ |
| `REFUND_REVERSED` | - | é€€æ¬¾æ’¤é”€ |
| `REVOKE` | - | å®¶åº­å…±äº«æ’¤é”€ |
| `CONSUMPTION_REQUEST` | - | æ¶ˆè€—è¯·æ±‚ |
| `ONE_TIME_CHARGE` | - | ä¸€æ¬¡æ€§è´­ä¹° |
| `TEST` | - | æµ‹è¯•é€šçŸ¥ |

### Webhook å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Server Notification V2 å¤„ç†æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Apple Server                 æœåŠ¡ç«¯                        æ•°æ®åº“
      â”‚                          â”‚                             â”‚
      â”‚  1. å‘é€ç­¾åé€šçŸ¥         â”‚                             â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                             â”‚
      â”‚  POST /webhook/apple     â”‚                             â”‚
      â”‚  {signedPayload: "xxx.yyy.zzz"}                        â”‚
      â”‚                          â”‚                             â”‚
      â”‚                          â”‚  2. è§£æ JWS                â”‚
      â”‚                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚                          â”‚  â”‚ - åˆ†å‰² header.payload.â”‚   â”‚
      â”‚                          â”‚  â”‚   signature           â”‚   â”‚
      â”‚                          â”‚  â”‚ - Base64 è§£ç          â”‚   â”‚
      â”‚                          â”‚  â”‚ - éªŒè¯ç­¾å            â”‚   â”‚
      â”‚                          â”‚  â”‚ - æå–é€šçŸ¥ç±»å‹        â”‚   â”‚
      â”‚                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                          â”‚                             â”‚
      â”‚                          â”‚  3. è§£æäº¤æ˜“ä¿¡æ¯           â”‚
      â”‚                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚                          â”‚  â”‚ signedTransactionInfo â”‚   â”‚
      â”‚                          â”‚  â”‚ - transactionId       â”‚   â”‚
      â”‚                          â”‚  â”‚ - originalTransactionIdâ”‚  â”‚
      â”‚                          â”‚  â”‚ - productId           â”‚   â”‚
      â”‚                          â”‚  â”‚ - purchaseDate        â”‚   â”‚
      â”‚                          â”‚  â”‚ - expiresDate         â”‚   â”‚
      â”‚                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                          â”‚                             â”‚
      â”‚                          â”‚  4. æ ¹æ®é€šçŸ¥ç±»å‹å¤„ç†       â”‚
      â”‚                          â”‚                             â”‚
      â”‚                          â”‚  SUBSCRIBED / DID_RENEW:    â”‚
      â”‚                          â”‚  - åˆ›å»º/æ›´æ–° ApplePayment   â”‚
      â”‚                          â”‚  - æ›´æ–° Order çŠ¶æ€ä¸º PAID   â”‚
      â”‚                          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                          â”‚                             â”‚
      â”‚                          â”‚  EXPIRED:                   â”‚
      â”‚                          â”‚  - æ›´æ–°è®¢é˜…çŠ¶æ€ä¸º EXPIRED   â”‚
      â”‚                          â”‚  - æ›´æ–° Order çŠ¶æ€         â”‚
      â”‚                          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                          â”‚                             â”‚
      â”‚                          â”‚  REFUND:                    â”‚
      â”‚                          â”‚  - åˆ›å»ºé€€æ¬¾è®°å½•            â”‚
      â”‚                          â”‚  - æ›´æ–°è®¢å•ä¸º REFUNDED     â”‚
      â”‚                          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                          â”‚                             â”‚
      â”‚  5. è¿”å› 200 OK         â”‚                             â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                             â”‚
      â”‚                          â”‚                             â”‚
      â””                          â””                             â””
```

### è®¢å•å…³è”æœºåˆ¶

Apple Webhook ä¸ç›´æ¥åŒ…å« `order_id`ï¼Œç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶å…³è”ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è®¢å•å…³è”æœºåˆ¶                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  é¦–æ¬¡è´­ä¹°æ—¶ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. å®¢æˆ·ç«¯åˆ›å»ºè®¢å• â†’ è·å¾— order_id                                         â”‚
  â”‚ 2. å®¢æˆ·ç«¯å®Œæˆè´­ä¹° â†’ è·å¾— transaction_id, original_transaction_id         â”‚
  â”‚ 3. å®¢æˆ·ç«¯è°ƒç”¨ verify-transaction â†’ æœåŠ¡ç«¯ä¿å­˜ ApplePayment               â”‚
  â”‚    ApplePayment {                                                        â”‚
  â”‚      order_id: 1,                           â† å…³è”è®¢å•                    â”‚
  â”‚      transaction_id: "1000000123456789",                                 â”‚
  â”‚      original_transaction_id: "1000000123456780"  â† å…³é”®ï¼šåŸå§‹äº¤æ˜“ID     â”‚
  â”‚    }                                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  åç»­ Webhook é€šçŸ¥æ—¶ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. æ”¶åˆ° Webhookï¼Œæå– original_transaction_id                            â”‚
  â”‚ 2. æŸ¥è¯¢ ApplePayment WHERE original_transaction_id = "1000000123456780"  â”‚
  â”‚ 3. è·å¾— order_id = 1                                                     â”‚
  â”‚ 4. æ›´æ–°å¯¹åº”çš„ Order çŠ¶æ€                                                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ App Store Server API

æ¨èä½¿ç”¨æ–°çš„ App Store Server API è€Œéæ—§çš„æ”¶æ®éªŒè¯ï¼š

```go
// æ¨èï¼šä½¿ç”¨ App Store Server API
response, err := appleService.VerifyTransaction(ctx, transactionID)

// ä¸æ¨èï¼šæ—§çš„æ”¶æ®éªŒè¯æ–¹å¼
// response, err := appleService.VerifyPurchase(ctx, receiptData, orderID)
```

### 2. æ­£ç¡®å¤„ç† StoreKit 2 äº¤æ˜“

iOS å®¢æˆ·ç«¯ä»£ç ç¤ºä¾‹ï¼š

```swift
// StoreKit 2 (iOS 15+)
func purchase(product: Product) async throws {
    // 1. è°ƒç”¨æœåŠ¡ç«¯åˆ›å»ºè®¢å•
    let order = try await api.createOrder(productId: product.id)
    
    // 2. å‘èµ·è´­ä¹°
    let result = try await product.purchase()
    
    switch result {
    case .success(let verification):
        let transaction = try checkVerified(verification)
        
        // 3. å‘é€äº¤æ˜“åˆ°æœåŠ¡ç«¯éªŒè¯
        try await api.verifyTransaction(
            transactionId: String(transaction.id),
            orderId: order.id
        )
        
        // 4. å®Œæˆäº¤æ˜“
        await transaction.finish()
        
    case .pending:
        // ç­‰å¾…æˆæƒï¼ˆå¦‚å®¶é•¿æ‰¹å‡†ï¼‰
        break
    case .userCancelled:
        // ç”¨æˆ·å–æ¶ˆ
        break
    @unknown default:
        break
    }
}
```

### 3. å¹‚ç­‰æ€§å¤„ç†

```go
func (s *AppleService) HandleNotification(ctx context.Context, notification *AppleNotification) error {
    // ä½¿ç”¨ notification_uuid ç¡®ä¿å¹‚ç­‰æ€§
    if s.isNotificationProcessed(notification.NotificationUUID) {
        s.logger.Info("Notification already processed",
            zap.String("notification_uuid", notification.NotificationUUID))
        return nil
    }
    
    // å¤„ç†é€šçŸ¥...
    
    s.markNotificationProcessed(notification.NotificationUUID)
    return nil
}
```

### 4. å®½é™æœŸå¤„ç†

```go
func (s *AppleService) handleDidFailToRenew(ctx context.Context, notification *AppleNotification) error {
    if notification.Subtype == "GRACE_PERIOD" {
        // åœ¨å®½é™æœŸå†…ï¼Œç”¨æˆ·ä»å¯ä½¿ç”¨æœåŠ¡
        // å¯ä»¥å‘é€æé†’é€šçŸ¥ç”¨æˆ·æ›´æ–°æ”¯ä»˜æ–¹å¼
        s.sendPaymentReminderNotification(payment.UserID)
        
        payment.GracePeriodStatus = "IN_GRACE_PERIOD"
    } else {
        // å®½é™æœŸå¤–ï¼Œåº”åœæ­¢æœåŠ¡
        payment.Status = "RENEWAL_FAILED"
    }
    
    return s.db.Save(&payment).Error
}
```

### 5. é€€æ¬¾å¤„ç†

```go
func (s *AppleService) handleRefund(ctx context.Context, notification *AppleNotification) error {
    // 1. åˆ›å»ºé€€æ¬¾è®°å½•
    refund := &models.AppleRefund{
        OrderID:             payment.OrderID,
        RefundTransactionID: transactionInfo.TransactionID,
        RefundStatus:        "REFUNDED",
        RefundDate:          transactionInfo.RevocationDate,
    }
    
    // 2. æ’¤é”€ç”¨æˆ·æƒç›Š
    s.revokeUserEntitlement(payment.OrderID)
    
    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    s.db.Model(&models.Order{}).
        Where("id = ?", payment.OrderID).
        Update("status", models.OrderStatusRefunded)
    
    return nil
}
```

## ç›¸å…³æ–‡æ¡£

- [App Store Server API](https://developer.apple.com/documentation/appstoreserverapi)
- [App Store Server Notifications V2](https://developer.apple.com/documentation/appstoreservernotifications)
- [StoreKit 2](https://developer.apple.com/documentation/storekit/in-app_purchase)
- [éªŒè¯è´­ä¹°](https://developer.apple.com/documentation/storekit/in-app_purchase/original_api_for_in-app_purchase/validating_receipts_with_the_app_store)

