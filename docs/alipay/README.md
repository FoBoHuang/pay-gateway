# æ”¯ä»˜å®æ¥å…¥æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•æ¥å…¥æ”¯ä»˜å®æ”¯ä»˜å’Œå‘¨æœŸæ‰£æ¬¾ï¼ˆè®¢é˜…ï¼‰åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [é…ç½®](#é…ç½®)
- [æ”¯ä»˜æµç¨‹](#æ”¯ä»˜æµç¨‹)
- [API æ¥å£](#api-æ¥å£)
- [Webhook å¤„ç†](#webhook-å¤„ç†)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## åŠŸèƒ½æ¦‚è¿°

æ”¯æŒçš„åŠŸèƒ½ï¼š

| åŠŸèƒ½ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|-----|
| æ‰‹æœºç½‘ç«™æ”¯ä»˜ | WAP H5 æ”¯ä»˜ | âœ… |
| ç”µè„‘ç½‘ç«™æ”¯ä»˜ | PC ç½‘é¡µæ”¯ä»˜ | âœ… |
| App æ”¯ä»˜ | åŸç”Ÿ App æ”¯ä»˜ | âœ… |
| å‘¨æœŸæ‰£æ¬¾ | ç­¾çº¦ä»£æ‰£/è®¢é˜… | âœ… |
| é€€æ¬¾ | åŸè·¯é€€å› | âœ… |
| å¼‚æ­¥é€šçŸ¥ | æ”¯ä»˜ç»“æœé€šçŸ¥ | âœ… |

## é…ç½®

### 1. åˆ›å»ºæ”¯ä»˜å®åº”ç”¨

1. ç™»å½• [æ”¯ä»˜å®å¼€æ”¾å¹³å°](https://open.alipay.com/)
2. åˆ›å»ºåº”ç”¨ï¼Œè·å– **AppID**
3. é…ç½®åº”ç”¨å…¬é’¥æˆ–ä¸Šä¼ è¯ä¹¦
4. å¼€é€šæ‰€éœ€äº§å“ï¼ˆæ‰‹æœºç½‘ç«™æ”¯ä»˜ã€ç”µè„‘ç½‘ç«™æ”¯ä»˜ã€å‘¨æœŸæ‰£æ¬¾ç­‰ï¼‰

### 2. é…ç½®å¯†é’¥

æ”¯æŒä¸¤ç§æ–¹å¼ï¼š

#### æ–¹å¼ä¸€ï¼šå…¬é’¥æ¨¡å¼

```toml
[alipay]
# åº”ç”¨ ID
app_id = "2021000000000000"

# åº”ç”¨ç§é’¥ï¼ˆPKCS1 æˆ– PKCS8 æ ¼å¼ï¼‰
private_key = '''
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA...
-----END RSA PRIVATE KEY-----
'''

# æ”¯ä»˜å®å…¬é’¥
alipay_public_key = '''
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
-----END PUBLIC KEY-----
'''

# æ˜¯å¦ç”Ÿäº§ç¯å¢ƒ
is_production = false

# è¯ä¹¦æ¨¡å¼
cert_mode = false

# å›è°ƒåœ°å€
notify_url = "https://your-domain.com/webhook/alipay/notify"
return_url = "https://your-domain.com/payment/success"
```

#### æ–¹å¼äºŒï¼šè¯ä¹¦æ¨¡å¼ï¼ˆæ¨èï¼‰

```toml
[alipay]
app_id = "2021000000000000"
private_key = "..."
is_production = false

# å¯ç”¨è¯ä¹¦æ¨¡å¼
cert_mode = true

# è¯ä¹¦è·¯å¾„
app_cert_path = "/path/to/appCertPublicKey.crt"
alipay_cert_path = "/path/to/alipayCertPublicKey_RSA2.crt"
root_cert_path = "/path/to/alipayRootCert.crt"

notify_url = "https://your-domain.com/webhook/alipay/notify"
return_url = "https://your-domain.com/payment/success"
```

### 3. å‘¨æœŸæ‰£æ¬¾é…ç½®

ä½¿ç”¨å‘¨æœŸæ‰£æ¬¾éœ€è¦é¢å¤–å¼€é€šï¼š

1. ç”³è¯·å¼€é€š **å‘¨æœŸæ‰£æ¬¾** äº§å“
2. è·å– **ä¸ªäººç­¾çº¦äº§å“ç **ï¼ˆå¦‚ `CYCLE_PAY_AUTH_P`ï¼‰
3. ç¡®å®š **ç­¾çº¦åœºæ™¯**ï¼ˆå¦‚ `INDUSTRY|MEDICAL_INSURANCE`ï¼‰

## æ”¯ä»˜æµç¨‹

### æ™®é€šæ”¯ä»˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ”¯ä»˜å®æ”¯ä»˜æµç¨‹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å®¢æˆ·ç«¯                     æœåŠ¡ç«¯                      æ”¯ä»˜å®
      â”‚                         â”‚                            â”‚
      â”‚  1. åˆ›å»ºè®¢å•            â”‚                            â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
      â”‚  POST /alipay/orders    â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â”‚  è¿”å› order_id, order_noâ”‚                            â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â”‚  2. åˆ›å»ºæ”¯ä»˜            â”‚                            â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
      â”‚  POST /alipay/payments  â”‚                            â”‚
      â”‚  {order_no, pay_type}   â”‚                            â”‚
      â”‚                         â”‚  è°ƒç”¨æ”¯ä»˜å®ä¸‹å•æ¥å£        â”‚
      â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                         â”‚                            â”‚
      â”‚  è¿”å›æ”¯ä»˜ URL/å‚æ•°      â”‚                            â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â”‚  3. è·³è½¬æ”¯ä»˜å®æ”¯ä»˜      â”‚                            â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚  (WAP/PAGE/APP)         â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â”‚  æ”¯ä»˜å®Œæˆï¼ŒåŒæ­¥è¿”å›     â”‚                            â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  4. å¼‚æ­¥é€šçŸ¥               â”‚
      â”‚                         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚                         â”‚  POST /webhook/alipay/notifyâ”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  éªŒè¯ç­¾åï¼Œæ›´æ–°è®¢å•        â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  è¿”å› "success"           â”‚
      â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                         â”‚                            â”‚
      â”‚  5. (å¯é€‰) ä¸»åŠ¨æŸ¥è¯¢     â”‚                            â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
      â”‚  GET /alipay/orders/query                            â”‚
      â”‚                         â”‚  è°ƒç”¨æŸ¥è¯¢æ¥å£              â”‚
      â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚  è¿”å›æœ€æ–°çŠ¶æ€           â”‚                            â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â””                         â””                            â””
```

### å‘¨æœŸæ‰£æ¬¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‘¨æœŸæ‰£æ¬¾ï¼ˆç­¾çº¦ï¼‰æµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å®¢æˆ·ç«¯                     æœåŠ¡ç«¯                      æ”¯ä»˜å®
      â”‚                         â”‚                            â”‚
      â”‚  1. åˆ›å»ºå‘¨æœŸæ‰£æ¬¾è®¢å•    â”‚                            â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
      â”‚  POST /alipay/subscriptions                         â”‚
      â”‚                         â”‚  è°ƒç”¨ç­¾çº¦æ¥å£              â”‚
      â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                         â”‚  è¿”å›ç­¾çº¦ URL              â”‚
      â”‚                         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚  è¿”å› sign_url          â”‚                            â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â”‚  2. è·³è½¬ç­¾çº¦é¡µé¢        â”‚                            â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                         â”‚                            â”‚
      â”‚  ç”¨æˆ·ç¡®è®¤ç­¾çº¦           â”‚                            â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  3. ç­¾çº¦æˆåŠŸé€šçŸ¥           â”‚
      â”‚                         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚                         â”‚  POST /webhook/alipay/subscriptionâ”‚
      â”‚                         â”‚  {status: "NORMAL", agreement_no}â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  ä¿å­˜åè®®å·ï¼Œæ›´æ–°çŠ¶æ€      â”‚
      â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                         â”‚                            â”‚
      â””                         â”‚                            â”‚
                                â”‚                            â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åç»­å‘¨æœŸæ‰£æ¬¾ (ç³»ç»Ÿè‡ªåŠ¨è§¦å‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  åˆ°æœŸè‡ªåŠ¨æ‰£æ¬¾             â”‚
      â”‚                         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚                         â”‚  POST /webhook/alipay/deductâ”‚
      â”‚                         â”‚  {status: "SUCCESS", amount}â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  è®°å½•æ‰£æ¬¾ï¼Œæ›´æ–°ç»Ÿè®¡        â”‚
      â”‚                         â”‚                            â”‚
      â””                         â””                            â””

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            è§£çº¦æµç¨‹                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å®¢æˆ·ç«¯                     æœåŠ¡ç«¯                      æ”¯ä»˜å®
      â”‚                         â”‚                            â”‚
      â”‚  ç”¨æˆ·å–æ¶ˆè®¢é˜…           â”‚                            â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
      â”‚  POST /alipay/subscriptions/cancel                  â”‚
      â”‚  {out_request_no, cancel_reason}                    â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  è°ƒç”¨è§£çº¦æ¥å£              â”‚
      â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                         â”‚  alipay.user.agreement.unsignâ”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  è¿”å›è§£çº¦ç»“æœ              â”‚
      â”‚                         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  æ›´æ–°åè®®çŠ¶æ€ä¸º STOP       â”‚
      â”‚                         â”‚                            â”‚
      â”‚  è¿”å›è§£çº¦æˆåŠŸ           â”‚                            â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â””                         â””                            â””
```

## API æ¥å£

### åˆ›å»ºè®¢å•

```http
POST /api/v1/alipay/orders
Content-Type: application/json

{
  "user_id": 1,
  "product_id": "premium_upgrade",
  "subject": "é«˜çº§ä¼šå‘˜å‡çº§",
  "body": "è§£é”å…¨éƒ¨é«˜çº§åŠŸèƒ½",
  "total_amount": 9900
}
```

**å“åº”ï¼š**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_id": 1,
    "order_no": "ORD20240101120000abcd1234",
    "total_amount": 9900,
    "subject": "é«˜çº§ä¼šå‘˜å‡çº§",
    "description": "è§£é”å…¨éƒ¨é«˜çº§åŠŸèƒ½"
  }
}
```

### åˆ›å»ºæ”¯ä»˜

```http
POST /api/v1/alipay/payments
Content-Type: application/json

{
  "order_no": "ORD20240101120000abcd1234",
  "pay_type": "WAP"
}
```

**pay_type å¯é€‰å€¼ï¼š**

| ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| `WAP` | æ‰‹æœºç½‘ç«™æ”¯ä»˜ | H5 é¡µé¢ |
| `PAGE` | ç”µè„‘ç½‘ç«™æ”¯ä»˜ | PC ç½‘é¡µ |
| `APP` | App æ”¯ä»˜ | åŸç”Ÿ App |

**å“åº”ï¼š**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "payment_url": "https://openapi.alipay.com/gateway.do?...",
    "order_no": "ORD20240101120000abcd1234"
  }
}
```

### æŸ¥è¯¢è®¢å•

```http
GET /api/v1/alipay/orders/query?order_no=ORD20240101120000abcd1234
```

**å“åº”ï¼š**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_no": "ORD20240101120000abcd1234",
    "trade_no": "2024010122001400001234567890",
    "trade_status": "TRADE_SUCCESS",
    "total_amount": 9900,
    "payment_status": "COMPLETED",
    "paid_at": "2024-01-01 12:05:30"
  }
}
```

### é€€æ¬¾

```http
POST /api/v1/alipay/refunds
Content-Type: application/json

{
  "order_no": "ORD20240101120000abcd1234",
  "refund_amount": 9900,
  "refund_reason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾"
}
```

**å“åº”ï¼š**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "refund_request_no": "REFORD20240101120000abcd1234130530",
    "refund_amount": 9900,
    "refund_status": "REFUND_SUCCESS",
    "refund_at": "2024-01-01 13:05:30"
  }
}
```

### åˆ›å»ºå‘¨æœŸæ‰£æ¬¾

```http
POST /api/v1/alipay/subscriptions
Content-Type: application/json

{
  "user_id": 1,
  "product_id": "monthly_vip",
  "product_name": "æœˆåº¦ä¼šå‘˜",
  "product_desc": "æ¯æœˆè‡ªåŠ¨ç»­è´¹",
  "period_type": "MONTH",
  "period": 1,
  "single_amount": 2999,
  "total_amount": 35988,
  "total_payments": 12,
  "personal_product_code": "CYCLE_PAY_AUTH_P",
  "sign_scene": "INDUSTRY|MEDICAL_INSURANCE",
  "execution_time": "2024-01-15T00:00:00Z"
}
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|-----|------|
| `period_type` | string | æ˜¯ | å‘¨æœŸç±»å‹ï¼š`DAY` æˆ– `MONTH` |
| `period` | int | æ˜¯ | å‘¨æœŸæ•° |
| `single_amount` | int64 | æ˜¯ | å•æ¬¡æ‰£æ¬¾é‡‘é¢ï¼ˆåˆ†ï¼‰ |
| `total_amount` | int64 | å¦ | æ€»é‡‘é¢é™åˆ¶ï¼ˆåˆ†ï¼‰ |
| `total_payments` | int | å¦ | æ€»æ‰£æ¬¾æ¬¡æ•°é™åˆ¶ |
| `execution_time` | string | å¦ | é¦–æ¬¡æ‰£æ¬¾æ—¶é—´ï¼ˆé»˜è®¤æ˜å¤©ï¼‰ |

**å“åº”ï¼š**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_id": 1,
    "out_request_no": "SUB20240101120000abcd1234",
    "sign_url": "https://openauth.alipay.com/oauth2/appToAppAuth.htm?...",
    "status": "TEMP",
    "execution_time": "2024-01-15 00:00:00"
  }
}
```

### æŸ¥è¯¢å‘¨æœŸæ‰£æ¬¾

```http
GET /api/v1/alipay/subscriptions/query?out_request_no=SUB20240101120000abcd1234
```

**å“åº”ï¼š**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "out_request_no": "SUB20240101120000abcd1234",
    "agreement_no": "20240101000000000000",
    "status": "NORMAL",
    "sign_time": "2024-01-01 12:05:30",
    "valid_time": "2024-01-01 12:05:30",
    "period_type": "MONTH",
    "period": 1,
    "single_amount": "29.99",
    "total_payments": 12,
    "current_period": 1,
    "next_deduct_time": "2024-02-01 00:00:00",
    "deduct_success_count": 1,
    "deduct_fail_count": 0
  }
}
```

### å–æ¶ˆå‘¨æœŸæ‰£æ¬¾

```http
POST /api/v1/alipay/subscriptions/cancel
Content-Type: application/json

{
  "out_request_no": "SUB20240101120000abcd1234",
  "agreement_no": "20240101000000000000",
  "cancel_reason": "ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ"
}
```

## Webhook å¤„ç†

### æ”¯ä»˜é€šçŸ¥

```
POST /webhook/alipay/notify
Content-Type: application/x-www-form-urlencoded

out_trade_no=ORD20240101120000abcd1234
&trade_no=2024010122001400001234567890
&trade_status=TRADE_SUCCESS
&total_amount=99.00
&buyer_user_id=2088000000000000
&gmt_payment=2024-01-01+12%3A05%3A30
&sign=xxx
&sign_type=RSA2
```

**trade_status çŠ¶æ€è¯´æ˜ï¼š**

| çŠ¶æ€ | è¯´æ˜ |
|-----|------|
| `WAIT_BUYER_PAY` | ç­‰å¾…ä¹°å®¶ä»˜æ¬¾ |
| `TRADE_SUCCESS` | äº¤æ˜“æˆåŠŸ |
| `TRADE_CLOSED` | äº¤æ˜“å…³é—­ |
| `TRADE_FINISHED` | äº¤æ˜“ç»“æŸï¼ˆä¸å¯é€€æ¬¾ï¼‰ |

### ç­¾çº¦é€šçŸ¥

```
POST /webhook/alipay/subscription

agreement_no=20240101000000000000
&out_request_no=SUB20240101120000abcd1234
&status=NORMAL
&sign_time=2024-01-01+12%3A05%3A30
```

**status çŠ¶æ€è¯´æ˜ï¼š**

| çŠ¶æ€ | è¯´æ˜ |
|-----|------|
| `TEMP` | æš‚å­˜ï¼Œç­‰å¾…ç”¨æˆ·ç­¾çº¦ |
| `NORMAL` | æ­£å¸¸ |
| `STOP` | å·²è§£çº¦ |

### æ‰£æ¬¾é€šçŸ¥

```
POST /webhook/alipay/deduct

agreement_no=20240101000000000000
&out_trade_no=DEDUCT20240201000000abcd1234
&trade_no=2024020122001400001234567891
&status=SUCCESS
&amount=29.99
```

## æœ€ä½³å®è·µ

### 1. ç­¾åéªŒè¯

æ‰€æœ‰ Webhook è¯·æ±‚å¿…é¡»éªŒè¯ç­¾åï¼š

```go
func (s *AlipayService) HandleNotify(ctx context.Context, notifyData map[string]string) error {
    // å°† map è½¬æ¢ä¸º url.Values
    formData := url.Values{}
    for k, v := range notifyData {
        formData.Set(k, v)
    }
    
    // éªŒè¯ç­¾å
    err := s.client.VerifySign(formData)
    if err != nil {
        return errors.New("ç­¾åéªŒè¯å¤±è´¥")
    }
    
    // å¤„ç†é€šçŸ¥...
}
```

### 2. å¹‚ç­‰æ€§å¤„ç†

ä½¿ç”¨è®¢å•å·ç¡®ä¿å¹‚ç­‰ï¼š

```go
func HandlePaymentNotify(notifyData map[string]string) error {
    outTradeNo := notifyData["out_trade_no"]
    
    // æŸ¥è¯¢è®¢å•
    var order models.Order
    err := db.Where("order_no = ?", outTradeNo).First(&order).Error
    if err != nil {
        return err
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
    if order.PaymentStatus == models.PaymentStatusCompleted {
        return nil // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›æˆåŠŸ
    }
    
    // å¤„ç†é€šçŸ¥...
}
```

### 3. è¿”å›æ­£ç¡®å“åº”

Webhook å¤„ç†æˆåŠŸå¿…é¡»è¿”å› `success`ï¼Œå¦åˆ™æ”¯ä»˜å®ä¼šé‡è¯•ï¼š

```go
func HandleAlipayNotify(c *gin.Context) {
    // è§£æé€šçŸ¥æ•°æ®
    notifyData := make(map[string]string)
    for key, values := range c.Request.Form {
        if len(values) > 0 {
            notifyData[key] = values[0]
        }
    }
    
    // å¤„ç†é€šçŸ¥
    err := alipayService.HandleNotify(c.Request.Context(), notifyData)
    if err != nil {
        c.String(http.StatusOK, "fail")
        return
    }
    
    // å¿…é¡»è¿”å› "success"
    c.String(http.StatusOK, "success")
}
```

### 4. å‘¨æœŸæ‰£æ¬¾æœ€ä½³å®è·µ

```go
// åˆ›å»ºå‘¨æœŸæ‰£æ¬¾æ—¶è®¾ç½®åˆç†çš„å‚æ•°
req := &CreateAlipaySubscriptionRequest{
    PeriodType:    "MONTH",
    Period:        1,
    SingleAmount:  2999,          // å•æ¬¡æœ€å¤§é‡‘é¢
    TotalAmount:   35988,         // æ€»é‡‘é¢é™åˆ¶ï¼ˆå¯é€‰ï¼‰
    TotalPayments: 12,            // æœ€å¤šæ‰£æ¬¾12æ¬¡
    ExecutionTime: nextMonth,     // é¦–æ¬¡æ‰£æ¬¾æ—¶é—´
}

// ç›‘æ§æ‰£æ¬¾å¤±è´¥
func MonitorDeductFailures() {
    var subscriptions []models.AlipaySubscription
    db.Where("deduct_fail_count > 0 AND status = ?", "NORMAL").Find(&subscriptions)
    
    for _, sub := range subscriptions {
        // å‘é€é€šçŸ¥æé†’ç”¨æˆ·
        if sub.DeductFailCount >= 3 {
            notifyUserPaymentIssue(sub.UserID)
        }
    }
}
```

### 5. é‡‘é¢å¤„ç†

æ”¯ä»˜å®é‡‘é¢å•ä½ä¸ºå…ƒï¼Œå†…éƒ¨å­˜å‚¨å»ºè®®ä½¿ç”¨åˆ†ï¼š

```go
// å°†åˆ†è½¬æ¢ä¸ºå…ƒå­—ç¬¦ä¸²
func formatAmount(amount int64) string {
    return fmt.Sprintf("%.2f", float64(amount)/100)
}

// å°†å…ƒå­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ†
func parseAmount(amountStr string) (int64, error) {
    amount, err := strconv.ParseFloat(amountStr, 64)
    if err != nil {
        return 0, err
    }
    return int64(amount * 100), nil
}
```

## ç›¸å…³æ–‡æ¡£

- [æ”¯ä»˜å®å¼€æ”¾å¹³å°](https://open.alipay.com/)
- [æ‰‹æœºç½‘ç«™æ”¯ä»˜](https://opendocs.alipay.com/open/02ivbs)
- [ç”µè„‘ç½‘ç«™æ”¯ä»˜](https://opendocs.alipay.com/open/270)
- [å‘¨æœŸæ‰£æ¬¾](https://opendocs.alipay.com/open/02fkar)
- [å¼‚æ­¥é€šçŸ¥](https://opendocs.alipay.com/open/203/105286)

